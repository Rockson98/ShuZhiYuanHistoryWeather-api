# API 故障排查指南

## 500 错误常见原因

### 1. 日期问题（最常见）
**问题**：使用了未来日期或太新的日期
- 和风天气历史数据通常只能查询过去的数据
- 建议使用至少 1-2 天前的日期

**解决方案**：
```powershell
# 使用昨天的日期（不传 date 参数，API 会自动使用昨天）
Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/weather/history?project_id=1001"

# 或使用明确的历史日期（例如 7 天前）
$yesterday = (Get-Date).AddDays(-7).ToString("yyyy-MM-dd")
Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/weather/history?project_id=1001&date=$yesterday"
```

### 2. Location ID 无效
**问题**：`project_id` 对应的 `location_id` 可能无效

**解决方案**：
- 检查 `config.py` 中的 `DEFAULT_PROJECTS` 配置
- 或通过环境变量 `WEATHER_PROJECTS_JSON` 配置正确的 `location_id`
- 或直接使用 `location` 参数而不是 `project_id`

### 3. 和风天气 API 额度问题
**问题**：和风天气账号没有历史数据查询额度

**解决方案**：
- 登录和风天气控制台检查额度
- 确认已购买历史数据查询服务

### 4. API Key 配置问题
**问题**：`QWEATHER_API_KEY` 未正确配置或已过期

**解决方案**：
- 在 Render Dashboard → Environment 中检查 `QWEATHER_API_KEY`
- 确认 API Key 有效且有历史数据查询权限

## 如何查看详细错误信息

### 方法 1：查看 Render 日志
1. 登录 Render Dashboard
2. 进入你的服务页面
3. 点击左侧 "Logs" 标签
4. 查看最新的错误日志

### 方法 2：测试健康检查端点
```powershell
Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/health"
```

检查返回的 `qweather_key` 是否为 `true`

### 方法 3：使用浏览器测试
直接在浏览器中访问：
```
https://shuzhiyuanhistoryweather-api.onrender.com/weather/history?project_id=1001
```

浏览器会显示详细的错误信息（JSON 格式）

## 测试步骤

### 步骤 1：测试健康检查
```powershell
$health = Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/health"
$health | ConvertTo-Json
```

### 步骤 2：测试历史天气（使用默认日期 - 昨天）
```powershell
$result = Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/weather/history?project_id=1001"
Write-Host "返回数据点数量: $($result.count)"
Write-Host "日期: $($result.date)"
```

### 步骤 3：测试历史天气（使用明确的历史日期）
```powershell
# 使用 7 天前的日期
$date = (Get-Date).AddDays(-7).ToString("yyyy-MM-dd")
$result = Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/weather/history?project_id=1001&date=$date"
$result.count
```

### 步骤 4：测试使用 location 参数
```powershell
# 直接使用 location_id
$result = Invoke-RestMethod -Uri "https://shuzhiyuanhistoryweather-api.onrender.com/weather/history?location=101281101"
$result.count
```

## 常见错误码

- **400**: 请求参数错误（如 location 为空）
- **404**: 历史天气数据为空（可能是日期太新或 location 无效）
- **500**: 服务器内部错误（查看 Render 日志获取详细信息）

## 更新代码后

如果修改了代码：
1. 提交到 GitHub
2. Render 会自动重新部署（如果启用了 autoDeploy）
3. 等待 2-5 分钟部署完成
4. 重新测试

